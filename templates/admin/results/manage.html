{% extends "admin/base_admin.html" %}
{% block page_title %}Manage Results - {{ game.event }}{% endblock %}
{% block content %}
<!-- Game Edit Modal -->
<div id="gameEditModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Edit Game</h2>
                    <button onclick="closeGameEditModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="gameEditForm">
                    <input type="hidden" id="editGameId">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Event</label>
                            <select id="editEvent" name="event" class="w-full px-3 py-2 border rounded-lg">
                                {% for event in config.FIELD_EVENTS + config.TRACK_EVENTS %}
                                <option value="{{ event }}">{{ event }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Gender</label>
                            <select id="editGender" name="gender" class="w-full px-3 py-2 border rounded-lg">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-2">Classes</label>
                            <input type="text" id="editClasses" name="classes" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Phase</label>
                            <input type="text" id="editPhase" name="phase" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Area</label>
                            <input type="text" id="editArea" name="area" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Day</label>
                            <input type="number" id="editDay" name="day" min="1" max="8" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Time</label>
                            <input type="time" id="editTime" name="time" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Number of Athletes</label>
                            <input type="number" id="editNbAthletes" name="nb_athletes" min="1" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Status</label>
                            <select id="editStatus" name="status" class="w-full px-3 py-2 border rounded-lg">
                                <option value="scheduled">Scheduled</option>
                                <option value="started">Started</option>
                                <option value="in_progress">In Progress</option>
                                <option value="finished">Finished</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-span-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="editPublished" name="published" class="mr-2">
                                Published
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="editWpaPoints" name="wpa_points" class="mr-2">
                                WPA Points
                            </label>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button type="button" onclick="closeGameEditModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Update Game
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Game Information Section -->
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="text-lg font-bold">Game Information
                    <span class="bg-amber-100 text-amber-500 px-2 py-1 rounded-full text-xs font-medium">
                        #{{ game.id }}
                    </span>
                    {% if game.event == 'High Jump' %}
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium ml-2">
                            Progressive Heights
                        </span>
                    {% elif game.event in ['Long Jump', 'Triple Jump', 'Shot Put', 'Discus Throw', 'Javelin Throw', 'Club Throw'] %}
                        <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium ml-2">
                            Qualification + Final
                        </span>
                    {% elif game.event in config.TRACK_EVENTS %}
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium ml-2">
                            Track Event
                        </span>
                    {% endif %}
                    {% if game.official %}
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium ml-2">
                            <i class="fas fa-stamp mr-1"></i>OFFICIAL
                        </span>
                    {% else %}
                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium ml-2">
                            <i class="fas fa-clock mr-1"></i>UNOFFICIAL
                        </span>
                    {% endif %}
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-3 text-sm">
                    <div><span class="font-semibold">Event:</span> {{ game.event }}</div>
                    <div><span class="font-semibold">Gender:</span> {{ game.genders }}</div>
                    <div><span class="font-semibold">Classes:</span> {{ game.classes }}</div>
                    <div><span class="font-semibold">Day {{ game.day }}</span> - {{ game.time }}</div>
                </div>
                {% if game.wpa_points %}
                <div class="mt-2 p-2 bg-purple-50 border border-purple-200 rounded">
                    <i class="fas fa-calculator text-purple-600 mr-2"></i>
                    <span class="text-purple-800 font-medium">WPA Points Enabled</span>
                </div>
                {% endif %}
                <!-- Event-specific information -->
                {% if game.event == 'High Jump' %}
                <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    <strong>High Jump Rules:</strong> Progressive heights system. Add attempts one by one as they happen.
                </div>
                {% elif game.event in ['Long Jump', 'Triple Jump', 'Shot Put', 'Discus Throw', 'Javelin Throw', 'Club Throw'] %}
                <div class="mt-2 p-2 bg-orange-50 border border-orange-200 rounded text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    <strong>Field Event Rules:</strong> 3 qualifying attempts, then top 8 advance to 3 final attempts (reverse order).
                </div>
                {% endif %}
                {% if game.official and game.official_date %}
                <div class="mt-2 text-sm text-green-700 bg-green-50 px-3 py-2 rounded">
                    <i class="fas fa-info-circle mr-1"></i>
                    <strong>Officialized:</strong> {{ game.official_date.strftime('%Y-%m-%d %H:%M:%S') }}
                    {% if game.official_by_username %}
                        by <strong>{{ game.official_by_username }}</strong>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="flex gap-2 flex-wrap">
                <script>
                window.gameEditData = {{ game_json|tojson }};
                </script>
                <button data-game-id="{{ game.id }}"
                        onclick="openGameEditModalFromGlobal({{ game.id }})"
                        class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                    <i class="fas fa-edit mr-1"></i>Edit Game
                </button>
                <form method="POST" action="{{ url_for('admin.game_update_status', id=game.id) }}" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="status" class="px-3 py-1 border rounded text-sm" onchange="this.form.submit()">
                        <option value="scheduled" {% if game.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="started" {% if game.status == 'started' %}selected{% endif %}>Started</option>
                        <option value="in_progress" {% if game.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="finished" {% if game.status == 'finished' %}selected{% endif %}>Finished</option>
                        <option value="cancelled" {% if game.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </form>
                {% if current_user.has_loc_privileges() %}
                <button onclick="togglePublish({{ game.id }}, event)"
                        class="px-3 py-1 rounded text-white text-sm {% if game.published %}bg-red-500 hover:bg-red-600{% else %}bg-green-500 hover:bg-green-600{% endif %}">
                    {% if game.published %}Unpublish{% else %}Publish{% endif %}
                </button>
                {% endif %}
                {% if current_user.is_technical_delegate() %}
                <button onclick="toggleGameOfficial({{ game.id }})"
                        class="{% if game.official %}bg-red-600 hover:bg-red-700{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white px-4 py-2 rounded text-sm font-medium"
                        title="{% if game.official %}Mark game as unofficial{% else %}Mark game as official{% endif %}">
                    <i class="fas fa-{% if game.official %}times{% else %}stamp{% endif %} mr-1"></i>
                    {% if game.official %}Mark UNOFFICIAL{% else %}Mark OFFICIAL{% endif %}
                </button>
                {% endif %}
                <button onclick="autoRankResults({{ game.id }}, event)"
                        class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600"
                        title="Auto-rank by performance{% if game.wpa_points %} and WPA Points{% endif %}">
                    <i class="fas fa-sort-numeric-down"></i> Auto Rank
                </button>
                {% if game.event in ['Long Jump', 'Triple Jump', 'Shot Put', 'Discus Throw', 'Javelin Throw', 'Club Throw'] %}
                <button onclick="selectFinalistsRound1({{ game.id }})"
                        class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600"
                        title="Select top 8 finalists from qualifying round">
                    <i class="fas fa-trophy"></i> Select Finalists
                </button>
                {% endif %}
                {% if game.wpa_points %}
                <button onclick="recalculateRaza({{ game.id }})"
                        class="bg-indigo-500 text-white px-3 py-1 rounded text-sm hover:bg-indigo-600"
                        title="Recalculate all WPA Points">
                    <i class="fas fa-calculator"></i> Recalc WPA
                </button>
                {% endif %}
                {% if game.event == 'High Jump' %}
                <button onclick="recalculateHighJump({{ game.id }})"
                        class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600"
                        title="Recalculate High Jump ranking with proper tie-breaking">
                    <i class="fas fa-sort-amount-up"></i> Recalc HJ
                </button>
                {% endif %}
                <a href="{{ url_for('admin.generate_game_pdf', game_id=game.id) }}"
                   class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600"
                   title="Generate PDF Results" target="_blank">
                    <i class="fas fa-file-pdf"></i> PDF
                </a>
            </div>
        </div>
    </div>
</div>
<!-- Wind Velocity Section -->
{% set show_wind = game.event in config.TRACK_EVENTS or game.event in config.WIND_AFFECTED_FIELD_EVENTS %}
{% if show_wind %}
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-lg font-bold mb-4">
            <i class="fas fa-wind text-blue-500 mr-2"></i>
            Wind Velocity Settings
        </h3>
        <div class="flex items-center gap-4 flex-wrap">
            <form method="POST" action="{{ url_for('admin.game_update_wind_velocity', game_id=game.id) }}" class="flex items-center gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="text-sm font-medium text-gray-700">Wind Velocity:</label>
                <div class="relative">
                    <input type="number"
                           name="wind_velocity"
                           step="0.01"
                           value="{% if game.wind_velocity is not none %}{{ "%.2f"|format(game.wind_velocity) }}{% endif %}"
                           class="w-24 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 text-center"
                           placeholder="0.00">
                    <span class="absolute right-2 top-1/2 transform -translate-y-1/2 text-sm text-gray-500">m/s</span>
                </div>
                <button type="submit"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm">
                    <i class="fas fa-save mr-1"></i>Update
                </button>
            </form>
            <div class="flex items-center gap-2 text-sm">
                <span class="text-gray-600">Current:</span>
                <span class="bg-lime-100 text-lime-800 px-2 py-1 rounded font-medium">
                    {% if game.wind_velocity is not none %}
                        {% if game.wind_velocity > 0 %}+{% endif %}{{ "%.2f"|format(game.wind_velocity) }} m/s
                    {% else %}
                        -
                    {% endif %}
                </span>
                {% if game.wind_velocity and game.wind_velocity > 2.0 %}
                    <span class="text-red-600 text-xs">
                        <i class="fas fa-exclamation-triangle"></i> Wind-assisted
                    </span>
                {% elif game.wind_velocity and game.wind_velocity < -2.0 %}
                    <span class="text-blue-600 text-xs">
                        <i class="fas fa-snowflake"></i> Strong headwind
                    </span>
                {% endif %}
            </div>
        </div>
        <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
            <i class="fas fa-info-circle mr-1"></i>
            <strong>Note:</strong> Wind velocity affects record eligibility. Tailwinds > +2.0 m/s make records ineligible.
        </div>
    </div>
</div>
{% endif %}
<!-- Add Result Section -->
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold mb-4">Add Result</h3>
        <form method="POST" action="{{ url_for('admin.result_add', game_id=game.id) }}" id="resultForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Athlete Selection -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Athlete *</label>
                    <div class="relative">
                        <input type="text" id="athleteSearch" placeholder="Search by SDMS, name, npc..."
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500"
                               autocomplete="off">
                        <div id="athleteResults" class="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                    </div>
                    <input type="hidden" name="athlete_sdms" id="selectedSdms" required>
                    <input type="hidden" name="guide_sdms" id="selectedGuideSdms">
                    <div id="selectedAthlete" class="mt-2 text-sm text-gray-600"
                         data-game-classes="{{ game.classes }}"
                         data-game-gender="{{ game.genders }}"></div>
                    <div id="selectedGuide" class="text-xs text-gray-500"></div>
                    <div class="mt-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Guide (optional)</label>
                        <div class="relative">
                            <input type="text" id="guideSearch" placeholder="Search guide" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" autocomplete="off">
                            <div id="guideResults" class="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
                <!-- Performance Value (Track Events Only) -->
                {% if game.event in config.TRACK_EVENTS %}
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Performance Value</label>
                        <input type="text" name="value" id="performanceValue"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500"
                               placeholder="MM:SS.SSSS, MM:SS, SS.SSSS or SS"
                               autocomplete="off">
                        <select class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500 mt-1"
                                onchange="selectSpecialValue(this.value)">
                            <option value="">Or select special value</option>
                            {% for val in config.RESULT_SPECIAL_VALUES %}
                                <option value="{{ val }}">{{ val }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
                <!-- Record -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Record</label>
                    <select name="record" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                        <option value="">None</option>
                        {% for record in config.RECORD_TYPES %}
                            <option value="{{ record }}">{{ record }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Weight (Weight Field Events Only) -->
                {% if game.event in config.WEIGHT_FIELD_EVENTS %}
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Weight (kg)</label>
                    <input name="weight" type="number" placeholder="X.XXX" step="0.001"
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                </div>
                {% endif %}
            </div>
            <!-- High Jump Specific Input -->
            {% if game.event == 'High Jump' %}
            <div class="mt-4">
                <h4 class="font-bold mb-2">Add High Jump Attempt</h4>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="text-sm text-gray-600">Height (m)</label>
                        <input type="number" step="0.01" name="height" placeholder="1.85"
                               class="w-full px-2 py-1 border rounded focus:outline-none focus:border-red-500">
                    </div>
                    <div>
                        <label class="text-sm text-gray-600">Result</label>
                        <select name="attempt_result" class="w-full px-2 py-1 border rounded focus:outline-none focus:border-red-500">
                            <option value="O">O (Success)</option>
                            <option value="X">X (Failure)</option>
                            <option value="-">- (Pass)</option>
                            <option value="XO">XO</option>
                            <option value="XXO">XXO</option>
                            <option value="XXX">XXX (Elimination)</option>
                        </select>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">For High Jump: Add attempts one by one as they happen. Height is required.</p>
            </div>
            <!-- Field Events (excluding High Jump) -->
            {% elif game.event in config.FIELD_EVENTS %}
            <div class="mt-4">
                <h4 class="font-bold mb-2">Attempts (6 attempts max)</h4>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                    {% for i in range(1,7) %}
                    <div>
                        <label class="text-sm text-gray-600">
                            Attempt {{ i }}
                            {% if i <= 3 %}
                                <span class="text-orange-500">(Q)</span>
                            {% else %}
                                <span class="text-blue-500">(F)</span>
                            {% endif %}
                        </label>
                        <input type="text" name="attempt-{{ i }}-value" id="attempt{{ i }}"
                               class="w-full px-2 py-1 border rounded focus:outline-none focus:border-red-500"
                               placeholder="XX.XX, X, O, -">
                        {% if game.event in config.WIND_AFFECTED_FIELD_EVENTS %}
                        <input type="number" step="0.01" name="wind-attempt-{{ i }}-value" id="wind-attempt{{ i }}"
                               class="mt-1 w-full px-2 py-1 border rounded focus:outline-none focus:border-red-500"
                               placeholder="±X.XX m/s">
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    <p><strong>Q</strong> = Qualifying attempts (1-3), <strong>F</strong> = Final attempts (4-6, only for top 8)</p>
                    <p>Valid values: numbers (15.67), X (failure), O (clearance), - (pass)</p>
                </div>
            </div>
            {% endif %}
            <div class="mt-4">
                <button type="submit" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                    <i class="fas fa-plus mr-2"></i>Add Result
                </button>
            </div>
        </form>
    </div>
</div>
<!-- Start List Section -->
{% if startlist %}
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-lg font-bold mb-3">Quick Select from Start List</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            {% for entry in startlist %}
            <div class="border rounded p-2 text-sm cursor-pointer hover:bg-gray-50 transition-colors"
                 onclick="selectFromStartList('{{ entry.athlete_sdms }}', '{{ entry.firstname|e }} {{ entry.lastname|e }}', '{{ entry.gender }}', '{{ entry.class }}', '{{ entry.guide_sdms or '' }}')">
                <span class="font-semibold">{{ entry.athlete_sdms }}</span> -
                {{ entry.firstname }} {{ entry.lastname }} ({{ entry.npc }})
                <span class="text-xs bg-blue-100 text-blue-800 px-1 rounded">{{ entry.class }}</span>
                {% if entry.guide_sdms %}
                    <div class="text-xs text-gray-500">Guide: {{ entry.guide_sdms }}</div>
                {% endif %}
                {% if entry.gender != game.genders %}
                    <div class="text-xs text-yellow-700 mt-1">
                        <i class="fas fa-exclamation-triangle"></i> Gender mismatch
                    </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
<!-- Results Table -->
<div class="bg-white rounded-lg shadow" id="resultsTable">
    <div class="p-6 border-b">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold">Current Results ({{ results|length }}/{{ game.nb_athletes }})</h3>
            <div class="flex gap-2 text-sm">
                {% if show_wind %}
                    <span class="bg-lime-100 text-lime-800 px-2 py-1 rounded">
                        Wind: {% if game.wind_velocity is not none %}{{ "%.2f"|format(game.wind_velocity) }} m/s{% else %}-{% endif %}
                    </span>
                {% endif %}
                {% if game.event in ['Long Jump', 'Triple Jump', 'Shot Put', 'Discus Throw', 'Javelin Throw', 'Club Throw'] %}
                    <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">
                        Finalists: {{ finalists_count|default(0) }}/8
                    </span>
                {% endif %}
                {% if game.wpa_points %}
                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">WPA Points</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% if results %}
    <div class="overflow-x-auto">
        <table class="w-full" id="sortableTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left cursor-move">
                        <i class="fas fa-grip-vertical text-gray-400"></i>
                    </th>
                    <th class="px-4 py-3 text-left">Rank</th>
                    <th class="px-4 py-3 text-left">SDMS</th>
                    <th class="px-4 py-3 text-left">Name</th>
                    <th class="px-4 py-3 text-left">NPC</th>
                    <th class="px-4 py-3 text-left">Class</th>
                    <th class="px-4 py-3 text-left">Guide</th>
                    {% if game.event in config.WEIGHT_FIELD_EVENTS %}
                        <th class="px-4 py-3 text-left">Weight</th>
                    {% endif %}
                    <th class="px-4 py-3 text-left">
                        Performance
                        {% if game.event in config.FIELD_EVENTS %}📏{% else %}⏱️{% endif %}
                    </th>
                    {% if game.event in ['Long Jump', 'Triple Jump', 'Shot Put', 'Discus Throw', 'Javelin Throw', 'Club Throw'] %}
                    <th class="px-4 py-3 text-left">R1 Order</th>
                    {% endif %}
                    {% if game.wpa_points %}
                    <th class="px-4 py-3 text-left">WPA Points</th>
                    {% endif %}
                    {% if game.event in config.FIELD_EVENTS %}
                    <th class="px-4 py-3 text-left">Attempts</th>
                    {% endif %}
                    <th class="px-4 py-3 text-left">Record</th>
                    <th class="px-4 py-3 text-left">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="sortableResults">
                {% for result in results %}
                <tr class="hover:bg-gray-50 draggable-row cursor-move"
                    data-result-id="{{ result.id }}"
                    data-current-rank="{{ loop.index }}">
                    <td class="px-4 py-4">
                        <i class="fas fa-grip-vertical text-gray-400"></i>
                    </td>
                    <td class="px-4 py-4">
                        {% set rank = result.rank|string if result.rank else loop.index|string %}
                        {% if rank == '1' %}
                            <span class="text-2xl mr-2">🥇</span><span class="font-bold text-yellow-600">{{ rank }}</span>
                        {% elif rank == '2' %}
                            <span class="text-2xl mr-2">🥈</span><span class="font-bold text-gray-600">{{ rank }}</span>
                        {% elif rank == '3' %}
                            <span class="text-2xl mr-2">🥉</span><span class="font-bold text-orange-600">{{ rank }}</span>
                        {% else %}
                            <span class="font-bold text-gray-900">{{ rank }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-sm font-semibold">{{ result.athlete_sdms }}</span>
                    </td>
                    <td class="px-4 py-4">
                        {{ result.lastname }} {{ result.firstname }}
                        {% if result.athlete_gender != game.genders %}
                            <div class="text-xs text-red-600">
                                <i class="fas fa-exclamation-triangle"></i> Gender: {{ result.athlete_gender }}
                            </div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <img src="{{ url_for('static', filename='images/flags/' + result.npc + '.svg') }}"
                                 alt="{{ result.npc }}"
                                 class="inline w-6 h-4 mr-1"
                                 onerror="this.style.display='none'">
                            {{ result.npc }}
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <span class="px-2 py-1 text-xs {% if result.athlete_class not in game.classes_list %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %} rounded">
                            {{ result.athlete_class }}
                        </span>
                    </td>
                    <td class="px-4 py-4">
                        {% if result.guide_sdms %}
                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-sm font-semibold">{{ result.guide_sdms }}</span>
                            <div class="text-xs text-gray-600">{{ result.guide_lastname }} {{ result.guide_firstname }}</div>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    {% if game.event in config.WEIGHT_FIELD_EVENTS %}
                    <td class="px-4 py-4">
                        {% if result.weight %}
                            <span class="px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded">
                                {{ "%.3f"|format(result.weight) }} kg
                            </span>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="px-4 py-4">
                        <div class="font-semibold text-lg">
                            {% if result.value in config.RESULT_SPECIAL_VALUES %}
                                <span class="text-red-600">{{ result.value }}</span>
                            {% else %}
                                {% if game.event in config.TRACK_EVENTS %}
                                    {{ result.value }}
                                {% elif game.event in config.FIELD_EVENTS %}
                                    {{ result.value }} m
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                    {% if game.event in ['Long Jump', 'Triple Jump', 'Shot Put', 'Discus Throw', 'Javelin Throw', 'Club Throw'] %}
                    <td class="px-4 py-4">
                        {% if result.final_order %}
                            <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-sm font-semibold">
                                {{ result.final_order }}/{{ total_finalists }}
                            </span>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if game.wpa_points %}
                    <td class="px-4 py-4">
                        {% if result.raza_score %}
                            <div class="text-lg font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded text-center">
                                {{ result.raza_score }}
                                {% if result.raza_score_precise %}
                                    <div class="text-xs">{{ "%.3f"|format(result.raza_score_precise) }}</div>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if game.event in config.FIELD_EVENTS %}
                    <td class="px-4 py-4">
                        {% if result.attempts %}
                            <button onclick="toggleAttempts({{ result.id }})" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-eye" id="attempts-icon-{{ result.id }}"></i> View
                            </button>
                            <script>
                            window.resultEditData_{{ result.id }} = {{ result|tojson }};
                            </script>
                            <button onclick="editAttemptsFromGlobal({{ result.id }})" class="ml-2 text-green-600 hover:text-green-800">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <div id="attempts-{{ result.id }}" class="hidden mt-2 text-xs">
                                <div class="grid grid-cols-3 gap-1">
                                    {% for attempt in result.attempts %}
                                        <div class="text-center border rounded px-1 py-1 {% if game.event == 'High Jump' and attempt.value == 'O' and attempt.height == result.value|float %}bg-green-100 border-green-300 font-bold{% elif attempt.value|float == result.value|float %}bg-green-100 border-green-300 font-bold{% else %}bg-gray-50{% endif %}">
                                            <div class="text-gray-500">
                                                {{ loop.index }}
                                                {% if game.event == 'High Jump' %}
                                                    <span class="text-purple-500">HJ</span>
                                                {% elif loop.index <= 3 %}
                                                    <span class="text-orange-500">Q</span>
                                                {% else %}
                                                    <span class="text-blue-500">F</span>
                                                {% endif %}
                                            </div>
                                            <div>{{ attempt.value or '-' }}</div>
                                            {% if game.wpa_points and attempt.raza_score %}
                                            <div class="text-purple-600">{{ attempt.raza_score }}</div>
                                            {% endif %}
                                            {% if game.event in config.WIND_AFFECTED_FIELD_EVENTS and attempt.wind_velocity %}
                                            <div>{{ "%.2f"|format(attempt.wind_velocity) }} m/s</div>
                                            {% endif %}
                                            {% if game.event == 'High Jump' and attempt.height %}
                                            <div>H: {{ attempt.height }}m</div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if game.event == 'High Jump' %}
                                <div class="mt-2 text-xs text-gray-600">
                                    <div>Max Height: {{ result.value }}m</div>
                                    {% set successful_attempts = result.attempts|selectattr('value', 'equalto', 'O')|list %}
                                    {% set failed_attempts = result.attempts|selectattr('value', 'equalto', 'X')|list %}
                                    {% set failures_at_max = failed_attempts|selectattr('height', 'equalto', result.value|float)|list|length %}
                                    {% set total_failures = failed_attempts|length %}
                                    <div>Failures at max: {{ failures_at_max }}</div>
                                    <div>Total failures: {{ total_failures }}</div>
                                    <div class="text-purple-600">Successful jumps: {{ successful_attempts|length }}</div>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="px-4 py-4">
                        {% if result.record %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                <i class="fas fa-trophy mr-1"></i>{{ result.record }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <button onclick="deleteResult({{ result.id }})" class="text-red-600 hover:text-red-900" title="Delete Result">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-medal text-4xl text-gray-300"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No results yet</h3>
        <p class="text-gray-500 mb-6">Start adding results for this {{ game.event }} event.</p>
    </div>
    {% endif %}
</div>
<!-- Edit Attempts Modal -->
<div id="editAttemptsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Edit Attempts - {{ game.event }}</h2>
                    <button onclick="closeEditAttemptsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="editAttemptsForm">
                    <input type="hidden" id="editResultId">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if game.event == 'High Jump' %}
                    <!-- High Jump specific interface -->
                    <div class="mb-4 p-4 bg-purple-50 border border-purple-200 rounded">
                        <h4 class="font-bold text-purple-800 mb-2">High Jump Attempts</h4>
                        <p class="text-sm text-purple-600 mb-3">Format: Height (m) + Result (O/X/-/XO/XXO/XXX)</p>
                        <div id="highJumpAttemptsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                    </div>
                    {% else %}
                    <!-- Other field events -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        {% for i in range(1, 7) %}
                        <div>
                            <label class="text-sm font-medium mb-1 block">
                                Attempt {{ i }}
                                {% if i <= 3 %}
                                    <span class="text-orange-500">(Q)</span>
                                {% else %}
                                    <span class="text-blue-500">(F)</span>
                                {% endif %}
                            </label>
                            <input type="text" id="editAttempt{{ i }}"
                                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                   placeholder="XX.XX, X, O, -">
                            {% if game.event in config.WIND_AFFECTED_FIELD_EVENTS %}
                            <input type="number" step="0.01" id="editWind{{ i }}"
                                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 mt-1"
                                   placeholder="Wind ±X.XX">
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if game.event in config.WEIGHT_FIELD_EVENTS %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Weight (kg)</label>
                        <input type="number" step="0.001" id="editWeight"
                               class="w-32 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="X.XXX">
                    </div>
                    {% endif %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Guide (optional)</label>
                        <div class="relative">
                            <input type="text" id="editGuideSearch" placeholder="Search guide"
                                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <div id="editGuideResults" class="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                        </div>
                        <input type="hidden" id="editGuideSdms">
                        <div id="editSelectedGuide" class="text-xs text-gray-500"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Record</label>
                        <select id="editRecord" class="w-40 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">None</option>
                            {% for record in config.RECORD_TYPES %}
                            <option value="{{ record }}">{{ record }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeEditAttemptsModal()"
                                class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Update Attempts
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    // Injecter les variables de configuration dans le JavaScript
    window.isFieldEvent = {{ 'true' if is_field_event else 'false' }};
    window.isTrackEvent = {{ 'true' if is_track_event else 'false' }};
    window.gameEvent = '{{ game.event|e }}';
    window.hasWpaPoints = {{ 'true' if game.wpa_points else 'false' }};
    window.specialValues = {{ config.RESULT_SPECIAL_VALUES|tojson|safe }};
    window.gameId = {{ game.id }};
    // Correction: utiliser true/false JavaScript au lieu de True/False Python
    window.finalistsCount = {{ total_selected_r1|default(0) }};
</script>
<script src="{{ url_for('static', filename='js/manage_results.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}