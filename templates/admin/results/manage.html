{% extends "admin/base_admin.html" %}

{% block page_title %}Manage Results - {{ game.event }}{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-lg font-bold">Game Information</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-3 text-sm">
            <div><span class="font-semibold">Event:</span> {{ game.event }}</div>
            <div><span class="font-semibold">Gender:</span> {{ game.gender }}</div>
            <div><span class="font-semibold">Classes:</span> {{ game.classes }}</div>
            <div><span class="font-semibold">Day {{ game.day }}</span> - {{ game.time }}</div>
        </div>
    </div>
</div>

<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold mb-4">Add Result</h3>
        <form method="POST" action="{{ url_for('admin.result_add', game_id=game.id) }}" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            {{ form.hidden_tag() }}

            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Athlete BIB</label>
                <select name="athlete_bib" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" required>
                    <option value="">Select athlete</option>
                    {% for athlete in athletes %}
                        <option value="{{ athlete.bib }}">{{ athlete.bib }} - {{ athlete.lastname }} {{ athlete.firstname }} ({{ athlete.country }})</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Rank</label>
                {{ form.rank(class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500", placeholder="1, 2, 3...") }}
            </div>

            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Performance Value</label>
                <select name="value" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" required onchange="checkSpecialValue(this)">
                    <option value="">Enter value</option>
                    <optgroup label="Special Values">
                        {% for val in config.RESULT_SPECIAL_VALUES %}
                            <option value="{{ val }}">{{ val }}</option>
                        {% endfor %}
                    </optgroup>
                </select>
                <input type="text" name="value_custom" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500 mt-2" placeholder="Or enter custom value" style="display: none;">
            </div>

            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2">Record</label>
                {{ form.record(class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500") }}
            </div>

            <div class="flex items-end">
                <button type="submit" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    Add Result
                </button>
            </div>
        </form>
    </div>
</div>

<div class="bg-white rounded-lg shadow">
    <div class="p-6 border-b">
        <h3 class="text-lg font-bold">Current Results ({{ results|length }}/{{ game.nb_athletes }})</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BIB</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Record</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for result in results %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if result.rank == '1' %}
                            <span class="text-2xl">ðŸ¥‡</span> {{ result.rank }}
                        {% elif result.rank == '2' %}
                            <span class="text-2xl">ðŸ¥ˆ</span> {{ result.rank }}
                        {% elif result.rank == '3' %}
                            <span class="text-2xl">ðŸ¥‰</span> {{ result.rank }}
                        {% else %}
                            {{ result.rank }}
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ result.athlete_bib }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ result.lastname }} {{ result.firstname }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="/static/images/flags/{{ result.country }}.svg" alt="{{ result.country }}" class="inline w-6 h-4 mr-1">
                        {{ result.country }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-semibold">{{ result.value }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if result.record %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                {{ result.record }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <form method="POST" action="{{ url_for('admin.result_delete', id=result.id) }}" class="inline"
                              onsubmit="return confirm('Are you sure you want to delete this result?');">
                            <button type="submit" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <h4 class="font-bold text-blue-900 mb-2">Legend:</h4>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-blue-800">
        <div><span class="font-semibold">DNS:</span> Did not start</div>
        <div><span class="font-semibold">DNF:</span> Did not finish</div>
        <div><span class="font-semibold">DSQ:</span> Disqualified</div>
        <div><span class="font-semibold">NM:</span> No mark</div>
        <div><span class="font-semibold">O:</span> Clearance</div>
        <div><span class="font-semibold">X:</span> Failure</div>
        <div><span class="font-semibold">-:</span> Pass</div>
    </div>
    <div class="mt-2">
        <span class="font-semibold">Record Types:</span>
        {% for record in config.RECORD_TYPES %}
            <span class="ml-2">{{ record }}</span>
        {% endfor %}
    </div>
</div>

<script>
function checkSpecialValue(select) {
    const customInput = document.querySelector('input[name="value_custom"]');
    const form = select.form;

    if (select.value === '') {
        customInput.style.display = 'block';
        customInput.required = true;
        customInput.name = 'value';
        select.name = 'value_select';
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.name = 'value_custom';
        select.name = 'value';
    }
}
</script>
{% endblock %}