{% extends "admin/base_admin.html" %}

{% block page_title %}Manage Results - {{ game.event }}{% endblock %}

{% block content %}
<!-- Game Information -->
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-lg font-bold">Game Information</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-3 text-sm">
            <div><span class="font-semibold">Event:</span> {{ game.event }}</div>
            <div><span class="font-semibold">Gender:</span> {{ game.gender }}</div>
            <div><span class="font-semibold">Classes:</span> {{ game.classes }}</div>
            <div><span class="font-semibold">Day {{ game.day }}</span> - {{ game.time }}</div>
        </div>

        {% if game.classes_list|length > 1 %}
        <div class="mt-2 p-2 bg-purple-50 border border-purple-200 rounded">
            <i class="fas fa-calculator text-purple-600 mr-2"></i>
            <span class="text-purple-800 font-medium">Multi-Class Event:</span>
            <span class="text-purple-700 text-sm">RASA scores will be calculated for fair comparison</span>
        </div>
        {% endif %}

        <div class="mt-4 flex gap-2 flex-wrap">
            <!-- Status Update Form -->
            <form method="POST" action="{{ url_for('admin.game_update_status', id=game.id) }}" class="inline">
                <!-- CSRF Token via form.hidden_tag() ou manual -->
                {% if form %}
                    {{ form.hidden_tag() }}
                {% else %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                {% endif %}

                <select name="status" class="px-3 py-1 border rounded" onchange="this.form.submit()">
                    <option value="scheduled" {% if game.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="started" {% if game.status == 'started' %}selected{% endif %}>Started</option>
                    <option value="in_progress" {% if game.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="finished" {% if game.status == 'finished' %}selected{% endif %}>Finished</option>
                    <option value="cancelled" {% if game.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </form>

            <!-- Publish Button -->
            {% if current_user.is_loc() %}
            <button onclick="togglePublish({{ game.id }}, event)"
                    class="px-4 py-1 rounded text-white {% if game.get('published', False) %}bg-red-500 hover:bg-red-600{% else %}bg-green-500 hover:bg-green-600{% endif %}">
                {% if game.get('published', False) %}Unpublish{% else %}Publish{% endif %}
            </button>
            {% endif %}

            <!-- Auto Rank Button -->
            <button onclick="autoRankResults({{ game.id }}, event)"
                    class="bg-purple-500 text-white px-4 py-1 rounded hover:bg-purple-600"
                    title="Auto-rank by performance or RASA score">
                <i class="fas fa-sort-numeric-down"></i> Auto Rank
            </button>
        </div>
    </div>
</div>

<!-- Add Result Form -->
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold mb-4">Add Result</h3>

        <!-- Error Messages -->
        <div id="errorMessages" class="hidden mb-4">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                <div class="flex">
                    <i class="fas fa-exclamation-circle mt-0.5 mr-2"></i>
                    <div>
                        <strong>Please fix the following errors:</strong>
                        <ul id="errorList" class="mt-2 ml-4 list-disc"></ul>
                    </div>
                </div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('admin.result_add', game_id=game.id) }}" id="resultForm">
            <!-- CSRF Protection unifi√© -->
            {% if form %}
                {{ form.hidden_tag() }}
            {% else %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Athlete Selection -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Athlete *</label>
                    <div class="relative">
                        <input type="text" id="athleteSearch" placeholder="Search by BIB, name, country..."
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                        <div id="athleteResults" class="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                    </div>
                    <input type="hidden" name="athlete_bib" id="selectedBib" required>
                    <div id="selectedAthlete" class="mt-2 text-sm text-gray-600" data-game-classes="{{ game.classes }}"></div>
                </div>

{#                <div>#}
{#                    <label class="block text-gray-700 text-sm font-bold mb-2">Rank</label>#}
{#                    {% if form and form.rank %}#}
{#                        {{ form.rank(class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500", placeholder="1, 2, 3...") }}#}
{#                    {% else %}#}
{#                        <input type="text" name="rank" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500" placeholder="1, 2, 3...">#}
{#                    {% endif %}#}
{#                </div>#}

                <!-- Performance Value -->
                    {% if is_track_event %}
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                Performance Value
                                {% if is_field_event %}
                                <small class="text-gray-500">(auto-filled from best attempt)</small>
                                {% endif %}
                            </label>
                            <input type="text" name="value" id="performanceValue"
                                   class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500"
                                   placeholder="MM:SS.CS or SS.CS" required>


                            <select class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500 mt-1"
                                    onchange="selectSpecialValue(this.value)">
                                <option value="">Or select special value</option>
                                {% for val in config.RESULT_SPECIAL_VALUES %}
                                    <option value="{{ val }}">{{ val }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}

                <!-- Record -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Record</label>
                    {% if form and form.record %}
                        {{ form.record(class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500") }}
                    {% else %}
                        <select name="record" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-red-500">
                            <option value="">None</option>
                            {% for record in config.RECORD_TYPES %}
                                <option value="{{ record }}">{{ record }}</option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>
            </div>

            <!-- Attempts Section for Field Events -->
            {% if is_field_event %}
            <div class="mt-4" id="attemptsSection">
                <h4 class="font-bold mb-2">Attempts (performance will be auto-filled from best attempt)</h4>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                    {% for i in range(6) %}
                    <div>
                        <label class="text-sm text-gray-600">Attempt {{ i + 1 }}</label>
                        <input type="text" name="attempts-{{ i }}-value" id="attempt{{ i }}"
                               class="w-full px-2 py-1 border rounded focus:outline-none focus:border-red-500"
                               placeholder="XX.XX">
                    </div>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-500 mt-2">Valid values: numbers (15.67), X (failure), O (clearance), - (pass)</p>
            </div>
            {% endif %}

            <div class="mt-4">
                <button type="submit" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                    <i class="fas fa-plus mr-2"></i>Add Result
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Quick Select from Start List -->
{% if startlist %}
<div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-lg font-bold mb-3">Quick Select from Start List</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            {% for entry in startlist %}
            <div class="border rounded p-2 text-sm cursor-pointer hover:bg-gray-50"
                 onclick="selectFromStartList('{{ entry.athlete_bib }}', '{{ entry.firstname|e }} {{ entry.lastname|e }}')">
                <span class="font-semibold">{{ entry.athlete_bib }}</span> -
                {{ entry.firstname }} {{ entry.lastname }} ({{ entry.country }})
                <span class="text-xs bg-blue-100 text-blue-800 px-1 rounded">{{ entry.class }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Current Results Table -->
<div class="bg-white rounded-lg shadow">
    <div class="p-6 border-b">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold">Current Results ({{ results|length }}/{{ game.nb_athletes }})</h3>
            <div class="text-sm text-gray-600">
                {% if game.classes_list|length > 1 %}
                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">Multi-Class Event</span>
                {% else %}
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">Single Class</span>
                {% endif %}
            </div>
        </div>
    </div>

    {% if results %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank üèÜ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BIB</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Performance {% if is_field_event %}üìè{% else %}‚è±Ô∏è{% endif %}
                    </th>
                    {% if game.classes_list|length > 1 %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RASA Score üßÆ</th>
                    {% endif %}
                    {% if is_field_event %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attempts</th>
                    {% endif %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Record</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for result in results %}
                <tr class="hover:bg-gray-50">
                    <!-- Rank with Medal -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% set rank = result.auto_rank or result.rank %}
                        {% if rank == '1' %}
                            <span class="text-2xl mr-2">ü•á</span><span class="font-bold text-yellow-600">{{ rank }}</span>
                        {% elif rank == '2' %}
                            <span class="text-2xl mr-2">ü•à</span><span class="font-bold text-gray-600">{{ rank }}</span>
                        {% elif rank == '3' %}
                            <span class="text-2xl mr-2">ü•â</span><span class="font-bold text-orange-600">{{ rank }}</span>
                        {% else %}
                            <span class="font-bold text-gray-900">{{ rank or '-' }}</span>
                        {% endif %}
                    </td>

                    <!-- BIB -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-sm font-semibold">{{ result.athlete_bib }}</span>
                    </td>

                    <!-- Name -->
                    <td class="px-6 py-4 whitespace-nowrap">{{ result.lastname }} {{ result.firstname }}</td>

                    <!-- Country -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="/static/images/flags/{{ result.country }}.svg" alt="{{ result.country }}" class="inline w-6 h-4 mr-1" onerror="this.style.display='none'">
                        {{ result.country }}
                    </td>

                    <!-- Class -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">{{ result.athlete_class }}</span>
                        {% if result.athlete_class not in game.classes_list %}
                            <span class="text-red-500 ml-1" title="Class not in event"><i class="fas fa-exclamation-triangle"></i></span>
                        {% endif %}
                    </td>

                    <!-- Performance -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-semibold text-lg">
                            {% if result.value in config.RESULT_SPECIAL_VALUES %}
                                <span class="text-red-600">{{ result.value }}</span>
                            {% else %}
                                {{ result.auto_performance or result.value }}
                                {% if is_field_event and result.value not in config.RESULT_SPECIAL_VALUES %}
                                    <span class="text-sm text-gray-500">m</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>

                    <!-- RASA Score -->
                    {% if game.classes_list|length > 1 %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if result.rasa_score %}
                            <div class="text-lg font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded text-center">{{ result.rasa_score }}</div>
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Attempts -->
                    {% if is_field_event %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if result.attempts %}
                            <button onclick="toggleAttempts({{ result.id }})" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-eye" id="attempts-icon-{{ result.id }}"></i> View
                            </button>
                            <div id="attempts-{{ result.id }}" class="hidden mt-2 text-xs">
                                <div class="grid grid-cols-3 gap-1">
                                    {% for attempt in result.attempts %}
                                        <div class="text-center border rounded px-1 py-1 {% if attempt.value == result.best_attempt %}bg-green-100 border-green-300 font-bold{% else %}bg-gray-50{% endif %}">
                                            <div class="text-gray-500">{{ loop.index }}</div>
                                            <div>{{ attempt.value or '-' }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Record -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if result.record %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                <i class="fas fa-trophy mr-1"></i>{{ result.record }}
                            </span>
                        {% endif %}
                    </td>

                    <!-- Actions -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="deleteResult({{ result.id }})" class="text-red-600 hover:text-red-900" title="Delete Result">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-medal text-4xl text-gray-300"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No results yet</h3>
        <p class="text-gray-500 mb-6">Start adding results for this {{ game.event }} event.</p>
    </div>
    {% endif %}
</div>

<!-- Legend -->
<div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <h4 class="font-bold text-blue-900 mb-2">Legend:</h4>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-blue-800">
        <div><span class="font-semibold">DNS:</span> Did not start</div>
        <div><span class="font-semibold">DNF:</span> Did not finish</div>
        <div><span class="font-semibold">DSQ:</span> Disqualified</div>
        <div><span class="font-semibold">NM:</span> No mark</div>
        {% if is_field_event %}
        <div><span class="font-semibold">O:</span> Clearance</div>
        <div><span class="font-semibold">X:</span> Failure</div>
        <div><span class="font-semibold">-:</span> Pass</div>
        {% endif %}
    </div>
    {% if game.classes_list|length > 1 %}
    <div class="mt-3 p-2 bg-purple-50 rounded">
        <span class="font-semibold text-purple-800">RASA Scoring:</span>
        <span class="text-purple-700 text-sm">Multi-class events use RASA scores for fair comparison between different disability classes.</span>
    </div>
    {% endif %}
</div>

<script>
// Global variables
const isFieldEvent = {{ 'true' if is_field_event else 'false' }};
const specialValues = {{ config.RESULT_SPECIAL_VALUES|tojson }};

// Function to get CSRF token
function getCSRFToken() {
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    return csrfInput ? csrfInput.value : '';
}

// Special value selection
function selectSpecialValue(value) {
    if (value) {
        document.getElementById('performanceValue').value = value;
        // Reset select
        event.target.value = '';
    }
}

// Athlete search functionality
let searchTimeout;
const athleteSearch = document.getElementById('athleteSearch');
const athleteResults = document.getElementById('athleteResults');
const selectedBib = document.getElementById('selectedBib');
const selectedAthlete = document.getElementById('selectedAthlete');

athleteSearch.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();

    if (query.length < 2) {
        athleteResults.classList.add('hidden');
        return;
    }

    searchTimeout = setTimeout(() => {
        fetch(`/admin/athletes/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(athletes => {
                athleteResults.innerHTML = '';
                if (athletes.length === 0) {
                    athleteResults.innerHTML = '<div class="p-2 text-gray-500">No athletes found</div>';
                } else {
                    athletes.forEach(athlete => {
                        const div = document.createElement('div');
                        div.className = 'p-2 hover:bg-gray-100 cursor-pointer border-b';
                        div.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div><strong>${athlete.bib}</strong> - ${athlete.name} (${athlete.country})</div>
                                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${athlete.class}</span>
                            </div>
                        `;
                        div.onclick = () => selectAthlete(athlete);
                        athleteResults.appendChild(div);
                    });
                }
                athleteResults.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Search error:', error);
                athleteResults.innerHTML = '<div class="p-2 text-red-500">Search failed</div>';
                athleteResults.classList.remove('hidden');
            });
    }, 300);
});

function selectAthlete(athlete) {
    selectedBib.value = athlete.bib;
    selectedAthlete.innerHTML = `Selected: <strong>${athlete.bib}</strong> - ${athlete.name} (${athlete.country})`;
    athleteSearch.value = '';
    athleteResults.classList.add('hidden');

    // Check class compatibility
    const gameClasses = selectedAthlete.dataset.gameClasses.split(',').map(c => c.trim());
    if (!gameClasses.includes(athlete.class)) {
        selectedAthlete.innerHTML += ` <span class="text-red-500"><i class="fas fa-exclamation-triangle"></i> Warning: Athlete class ${athlete.class} not in game classes</span>`;
    }
}

function selectFromStartList(bib, name) {
    selectedBib.value = bib;
    selectedAthlete.innerHTML = `Selected: <strong>${bib}</strong> - ${name}`;
    athleteSearch.value = '';
    athleteResults.classList.add('hidden');
}

function toggleAttempts(resultId) {
    const attemptsDiv = document.getElementById(`attempts-${resultId}`);
    const icon = document.getElementById(`attempts-icon-${resultId}`);

    if (attemptsDiv.classList.contains('hidden')) {
        attemptsDiv.classList.remove('hidden');
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        attemptsDiv.classList.add('hidden');
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function deleteResult(resultId) {
    if (confirm('Are you sure you want to delete this result?')) {
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/results/${resultId}/delete`;

        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = getCSRFToken();

        form.appendChild(csrfToken);
        document.body.appendChild(form);
        form.submit();
    }
}

function togglePublish(gameId, event) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

    fetch(`/admin/games/${gameId}/publish`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            button.innerHTML = originalText;
            button.disabled = false;
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating publish status');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function autoRankResults(gameId, event) {
    if (confirm('Auto-rank all results based on performance/RASA scores? This will update ranks automatically.')) {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ranking...';
        button.disabled = true;

        fetch(`/admin/games/${gameId}/auto-rank`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Results auto-ranked successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error auto-ranking results');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

// Close search when clicking outside
document.addEventListener('click', function(e) {
    if (!athleteSearch.contains(e.target) && !athleteResults.contains(e.target)) {
        athleteResults.classList.add('hidden');
    }
});
</script>
{% endblock %}
